<div class="bootstrap-wrapper">
  <div class="container-fluid">
    
    <!-- Header -->
    <div class="row mb-4">
      <div class="col-12">
        <h1 class="text-center title-wine">üì∞ Sistema de Noticias Municipales</h1>
        <p class="text-center text-muted">
          <span *ngIf="!isLoggedIn">Consulte las √∫ltimas noticias oficiales del municipio</span>
          <span *ngIf="isLoggedIn && userRole === 'ADMIN'">Panel administrativo - Gestione las noticias oficiales</span>
          <span *ngIf="isLoggedIn && userRole === 'TRABAJADOR'">Panel de trabajador - Publique noticias municipales</span>
          <span *ngIf="isLoggedIn && userRole === 'USUARIO'">Consulte las noticias oficiales publicadas</span>
        </p>
      </div>
    </div>

    <!-- Panel de Autenticaci√≥n (Solo si no est√° logueado) -->
    <div *ngIf="!isLoggedIn" class="row mb-4">
      <div class="col-12">
        <div class="auth-required-panel text-center">
          <div class="alert alert-info">
            <mat-icon class="large-icon">info</mat-icon>
            <h5>üîê Autenticaci√≥n Requerida</h5>
            <p><strong>Permisos del sistema:</strong></p>
            <ul class="text-start">
              <li><strong>üëÅÔ∏è USUARIO:</strong> Solo visualizaci√≥n de noticias</li>
              <li><strong>üîß TRABAJADOR:</strong> Crear, editar y eliminar noticias</li>
              <li><strong>üë®‚Äçüíº ADMIN:</strong> Gesti√≥n completa del sistema</li>
            </ul>
            <p>Inicie sesi√≥n para acceder seg√∫n su rol asignado</p>
            <button mat-raised-button color="primary" (click)="irALogin()">
              <mat-icon>login</mat-icon>
              Iniciar Sesi√≥n
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Panel Principal (Solo para usuarios autenticados) -->
    <div *ngIf="isLoggedIn" class="row">
      
      <!-- FORMULARIO DE CREACI√ìN (Para ADMIN y TRABAJADOR) -->
      <div class="col-lg-5" *ngIf="canManageNoticias()">
        <mat-card class="form-card">
          <mat-card-header>
            <div mat-card-avatar [class]="userRole === 'ADMIN' ? 'admin-avatar' : 'worker-avatar'">
              <mat-icon>{{ userRole === 'ADMIN' ? 'admin_panel_settings' : 'work' }}</mat-icon>
            </div>
            <mat-card-title class="text-wine">üìù Crear Nueva Noticia</mat-card-title>
            <mat-card-subtitle>
              <span *ngIf="userRole === 'ADMIN'">Publicar informaci√≥n oficial del municipio</span>
              <span *ngIf="userRole === 'TRABAJADOR'">Informar a la ciudadan√≠a sobre actividades municipales</span>
            </mat-card-subtitle>
          </mat-card-header>
          
          <mat-card-content>
            <form (ngSubmit)="crearNoticia()">
              
              <!-- T√≠tulo -->
              <mat-form-field class="full-width" appearance="outline">
                <mat-label>T√≠tulo de la Noticia</mat-label>
                <input 
                  matInput 
                  [(ngModel)]="noticia.titulo" 
                  name="titulo" 
                  maxlength="200"
                  placeholder="Ej: Nueva obra de pavimentaci√≥n en el centro de la ciudad">
                <mat-icon matSuffix>title</mat-icon>
                <mat-hint>{{noticia.titulo.length}}/200 caracteres</mat-hint>
              </mat-form-field>

              <!-- Autor -->
              <mat-form-field class="full-width" appearance="outline">
                <mat-label>Autor/Responsable</mat-label>
                <input 
                  matInput 
                  [(ngModel)]="noticia.autor" 
                  name="autor" 
                  maxlength="100"
                  placeholder="Nombre del autor o √°rea responsable">
                <mat-icon matSuffix>person</mat-icon>
              </mat-form-field>

              <!-- Descripci√≥n -->
              <mat-form-field class="full-width" appearance="outline">
                <mat-label>Contenido de la Noticia</mat-label>
                <textarea 
                  matInput 
                  [(ngModel)]="noticia.descripcion" 
                  name="descripcion" 
                  rows="4"
                  maxlength="1000"
                  placeholder="Describa la noticia con todos los detalles relevantes para los ciudadanos...">
                </textarea>
                <mat-icon matSuffix>description</mat-icon>
                <mat-hint>{{noticia.descripcion.length}}/1000 caracteres</mat-hint>
              </mat-form-field>

              <!-- Selecci√≥n de Imagen -->
              <div class="mb-3">
                <label class="form-label fw-bold text-wine">
                  <mat-icon class="me-1">add_photo_alternate</mat-icon>
                  Imagen Ilustrativa
                </label>
                <input 
                  type="file" 
                  class="form-control" 
                  accept="image/*"
                  (change)="onImageSelected($event)">
                <small class="text-muted">M√°ximo 5MB. Formatos: JPG, PNG, GIF</small>
              </div>

              <!-- Preview de la imagen -->
              <div *ngIf="imagenPreview" class="mb-3 text-center">
                <div class="preview-container">
                  <img [src]="imagenPreview" alt="Vista previa" class="img-preview">
                  <div class="preview-overlay">
                    <mat-icon>visibility</mat-icon>
                    <p>Vista previa</p>
                  </div>
                </div>
              </div>

              <!-- Botones -->
              <div class="d-flex gap-2">
                <button 
                  type="button" 
                  mat-raised-button 
                  color="accent"
                  (click)="limpiarFormulario()"
                  class="flex-fill">
                  <mat-icon>clear</mat-icon>
                  Limpiar
                </button>
                
                <button 
                  type="submit" 
                  mat-raised-button 
                  class="btn-wine flex-fill"
                  [disabled]="enviando">
                  <mat-icon>{{ enviando ? 'hourglass_empty' : 'publish' }}</mat-icon>
                  {{ enviando ? 'Publicando...' : 'Publicar Noticia' }}
                </button>
              </div>

            </form>
          </mat-card-content>
        </mat-card>
      </div>

      <!-- Panel de Solo Lectura (Para usuarios USUARIO) -->
      <div *ngIf="isReadOnlyUser()" class="col-12 mb-4">
        <div class="alert alert-info-custom text-center">
          <mat-icon class="large-icon">visibility</mat-icon>
          <h5>üëÄ Modo Solo Lectura</h5>
          <p>Conectado como <strong>{{userRole}}</strong>. Puede visualizar todas las noticias publicadas.</p>
          <p>Para crear o gestionar noticias, contacte con el administrador del sistema.</p>
        </div>
      </div>

      <!-- LISTA DE NOTICIAS -->
      <div [class]="canManageNoticias() ? 'col-lg-7' : 'col-12'">
        <mat-card class="list-card">
          <mat-card-header>
            <div mat-card-avatar class="news-avatar">
              <mat-icon>newspaper</mat-icon>
            </div>
            <mat-card-title class="text-wine">
              üì∞ Noticias Publicadas
              <span class="badge badge-wine ms-2">{{ noticias.length }}</span>
            </mat-card-title>
            <mat-card-subtitle>
              √öltimas noticias oficiales del municipio
            </mat-card-subtitle>
          </mat-card-header>
          
          <mat-card-content>
            
            <!-- Bot√≥n de Recarga -->
            <div class="text-end mb-3">
              <button mat-icon-button (click)="cargarNoticias()" matTooltip="Actualizar noticias">
                <mat-icon>refresh</mat-icon>
              </button>
            </div>

            <!-- Loading -->
            <div *ngIf="cargando" class="text-center p-4">
              <mat-spinner diameter="50"></mat-spinner>
              <p class="mt-3">Cargando noticias...</p>
            </div>

            <!-- Sin noticias -->
            <div *ngIf="!cargando && noticias.length === 0" class="text-center p-5">
              <mat-icon class="empty-icon">article</mat-icon>
              <h5>üì∞ No hay noticias publicadas</h5>
              <p class="text-muted">
                <span *ngIf="canManageNoticias()">Cree la primera noticia usando el formulario</span>
                <span *ngIf="!canManageNoticias()">A√∫n no se han publicado noticias oficiales</span>
              </p>
            </div>

            <!-- Lista de noticias -->
            <div *ngIf="!cargando && noticias.length > 0" class="noticias-container">
              <div class="noticia-item" *ngFor="let noticia of noticias; let i = index">
                
                <!-- Header de la noticia -->
                <div class="noticia-header">
                  <div class="author-info">
                    <div class="author-avatar">
                      {{ getInitials(noticia.autor) }}
                    </div>
                    <div class="author-details">
                      <p class="author-name">{{ noticia.autor }}</p>
                      <p class="publish-date">
                        <mat-icon class="icon-small">schedule</mat-icon>
                        {{ formatearFecha(noticia.fecha!) }}
                      </p>
                    </div>
                  </div>
                  
                  <!-- Acciones (Para ADMIN y TRABAJADOR) -->
                  <div class="noticia-acciones" *ngIf="canManageNoticias()">
                    <button 
                      mat-icon-button 
                      color="warn"
                      (click)="eliminarNoticia(noticia.id!)"
                      matTooltip="Eliminar noticia">
                      <mat-icon>delete</mat-icon>
                    </button>
                  </div>
                </div>
                
                <!-- T√≠tulo -->
                <h4 class="noticia-titulo">{{ noticia.titulo }}</h4>
                
                <!-- Imagen -->
                <div class="noticia-imagen" *ngIf="noticia.imagen">
                  <img 
                    [src]="'http://localhost:8080/uploads/' + noticia.imagen" 
                    [alt]="noticia.titulo"
                    (error)="$any($event.target).src='assets/images/noticia.jpeg'"
                    class="img-fluid">
                </div>
                
                <!-- Contenido -->
                <div class="noticia-contenido">
                  <p class="noticia-descripcion">{{ noticia.descripcion }}</p>
                </div>
                
                <!-- Separador -->
                <mat-divider *ngIf="i < noticias.length - 1" class="my-4"></mat-divider>
                
              </div>
            </div>

          </mat-card-content>
        </mat-card>
      </div>

    </div>

    <!-- Footer informativo -->
    <div class="row mt-5">
      <div class="col-12">
        <div class="footer-info text-center text-muted">
          <small>
            <mat-icon class="icon-small">info</mat-icon>
            Sistema de Gesti√≥n Municipal - Noticias Oficiales
          </small>
        </div>
      </div>
    </div>

  </div>
</div>
